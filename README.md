## Введение
Мониторинг позволяет вовремя выявлять проблемы в системе, а оповещения через такие инструменты, как Grafana OnCall, 
помогают быстро среагировать команде. В статье описано, как связать между собой различные инструменты, чтобы инцидент 
автоматически отслеживался от правила мониторинга до уведомления в мессенджере. 
Это особенно полезно для DevOps инженеров, строящих надёжную систему мониторинга.

## Общая схема прохождения алерта
### Архитектура решения
В данной архитектуре для мониторинга метрик используется Prometheus-совместимая система — VictoriaMetrics с её 
компонентом vmalert. Сначала создаётся alert rule (правило срабатывания) и применяется 
к vmalert. Как только условие правила выполняется, vmalert формирует алерт и отправляет его в Alertmanager. Alertmanager 
занимается маршрутизацией алертов, их группировкой, устранением дублирования и переадресацией по настройкам. Следующий 
этап — передача алерта из Alertmanager в Grafana OnCall, который уже отвечает за координацию оповещений: учитывает 
расписания дежурных, каналы связи и собственную логику эскалаций. После обработки события в OnCall ответственным 
лицам отправляется уведомление — в нашем случае посредством Telegram.

Такой подход позволяет гибко настроить процесс реагирования на инциденты: алерты по цепочке проходят через все нужные 
этапы фильтрации, маршрутизации и эскалации для быстрого и адресного оповещения нужных сотрудников.

### Визуальная схема (диаграмма прохождения алерта)
```
Prometheus Rule → vmalert → Alertmanager → Grafana OnCall → Telegram
```
Эта диаграмма отражает основной путь прохождения алерта — от возникновения события в метриках до получения уведомления 
в мессенджере ответственным сотрудником.

## VMAlert: обработка и маршрутизация алертов
### Что такое VMAlert
VMAlert — это компонент стека мониторинга VictoriaMetrics, предназначенный для оценки правил алертинга (alerting rules)
в стиле Prometheus и генерации алертов на их основе. VMAlert берет на вход файл (или список файлов) с alert rule'ами,
периодически опрашивает метрики (как правило, из VictoriaMetrics или Prometheus-compatible источников), вычисляет
выражения и при их срабатывании формирует события алерта. Далее он направляет сформированные алерты в Alertmanager
для дальнейшей маршрутизации и обработки.

### Создадим prometheus rule, которое будет алертить всегда для тестирования цепочки

Для тестирования всей цепочки прохождения алерта, логично начать с самого простого варианта — создать правило, которое 
будет алертить всегда, независимо от состояния системы. Это позволит убедиться, что весь процесс — от генерации события 
до получения уведомления в Telegram — работает корректно.

Создадим yaml-файл с Prometheus alert rule, например, `always-fire-rule.yaml`:

```yaml
groups:
  - name: always-fire
    rules:
      - alert: AlwaysFiring
        expr: 1 == 1
        for: 1m
        labels:
          severity: test
        annotations:
          summary: "Тестовое оповещение: Always firing"
          description: "Это тестовый алерт для проверки прохождения цепочки уведомлений."
```

Это правило срабатывает всегда, поскольку выражение `1 == 1` всегда истинно. Мы задаём небольшую продолжительность 
`for: 1m`, после чего алерт переходит в состояние firing. Внутри правила мы также указываем произвольные метки и 
аннотации, которые пригодятся для идентификации тестового оповещения при просмотре в Grafana OnCall или получении 
в Telegram.

### Конфигурация интеграции с VictoriaMetrics
Для того чтобы настроить интеграцию VMAlert с VictoriaMetrics, необходимо определить параметры источника данных и 
задать соответствующие параметры для оповещения. В конфигурационном файле VMAlert (либо через переменные окружения или 
флаги командной строки) требуется указать URL-адрес VictoriaMetrics (или другой совместимой time series базы) через 
опцию `-datasource.url`. Далее указываются файлы или директории с alert rule'ами через параметр `-rule` или `-rule.file`.

Для отправки алертов в Alertmanager указывается параметр `-notifier.url`, в котором прописывается адрес работающего 
экземпляра Alertmanager. Например:
```yaml
vmalert
-datasource.url=http://victoria-metrics:8428
-rule=/etc/vmalert/rules/*.yml
-notifier.url=http://alertmanager:9093
```

## Alertmanager: управление алертами и маршрутизация

Alertmanager — это ключевой компонент в экосистеме мониторинга Prometheus, предназначенный для централизованного 
управления поступающими алертами. Он обеспечивает маршрутизацию, группировку, подавление (silencing) и обработку 
дубликатов алертов, а также их доставку до конечных получателей с учетом выбранных каналов и политик оповещений.

### Основные возможности Alertmanager

Alertmanager принимает алерты от Prometheus (или других источников, например, vmalert из VictoriaMetrics), 
обрабатывает их в соответствии с заданными правилами и передаёт уведомления в указанные интеграции, такие как почта, 
PagerDuty, Slack, а также специализированные сервисы для управления инцидентами — например, Grafana OnCall. 
Среди ключевых возможностей можно выделить гибкую маршрутизацию алертов по различным критериям (например, по 
серьезности или источнику), обеспечение отказоустойчивости за счет кластеризации, возможность устанавливать временные 
периоды тихих часов (silence) или мьютировать одни и те же алерты, чтобы избежать избыточных уведомлений.

### Пример конфигурации для отправки в OnCall

Для интеграции Alertmanager с Grafana OnCall достаточно добавить в конфигурацию Alertmanager соответствующий 
получатель (receiver) с webhook-URL, предоставленным Grafana OnCall. Пример конфигурации может выглядеть 
следующим образом:

```yaml
global:
  resolve_timeout: 5m

route:
  receiver: 'oncall-webhook'
  group_by: ['alertname', 'cluster']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 3h

receivers:
  - name: 'oncall-webhook'
    webhook_configs:
      - url: 'https://YOUR_ONCALL_URL/webhook/prometheus?integration_key=YOUR_INTEGRATION_KEY'
        send_resolved: true
```

В этом примере создаётся receiver (получатель) с именем `oncall-webhook`, который использует webhook для отправки 
алертов напрямую в Grafana OnCall. В URL указывается уникальный путь интеграции и ключ, который можно получить в 
настройках Grafana OnCall для вашей службы. Опция `send_resolved` позволяет уведомлять OnCall также о том, что 
алерт был устранён.

## Интеграция Grafana OnCall с Alertmanager
### Обзор Grafana OnCall

Grafana OnCall — это современное решение для управления дежурствами (on-call) и оповещениями в командах, занимающихся 
поддержкой инфраструктуры и приложений. Инструмент позволяет централизованно обрабатывать алерты из различных 
источников мониторинга, маршрутизировать их по необходимым каналам, создавать дежурства и эскалационные пути, а 
также автоматизировать оповещение нужных специалистов. OnCall интегрируется с популярными системами мониторинга, 
такими как Prometheus, Alertmanager, VictoriaMetrics и другими, а также позволяет отправлять уведомления через 
мессенджеры (например, Telegram), SMS или email.

### Подключение источника алертов

Для интеграции Grafana OnCall c системой мониторинга, построенной на базе Prometheus и VictoriaMetrics, необходимо 
корректно связать цепочку генерации и доставки алертов:  
Prometheus генерирует alert согласно заданным правилам и отправляет их в компонент vmalert (часть VictoriaMetrics), 
который транслирует эти алерты в Alertmanager. Alertmanager, в свою очередь, выполняет агрегацию, группировку и 
маршрутизацию алертов, а затем пересылает их в Grafana OnCall.

Чтобы Alertmanager мог отправлять алерты в Grafana OnCall, нужно в конфигурационный файл Alertmanager (обычно это 
`alertmanager.yml`) добавить новый webhook receiver с endpoint, предоставляемым OnCall. Затем, в пользовательском 
интерфейсе OnCall, создаётся интеграция типа Alertmanager, где система генерирует URL, на который должны приходить 
алерты. Этот адрес и указывается в Alertmanager.

Например, фрагмент в `alertmanager.yml` может выглядеть так:
```yaml
receivers:
  - name: 'grafana-oncall'
    webhook_configs:
      - url: 'https://oncall.example.com/webhooks/alertmanager/xxxxxxxxxxxx'
```
После этого все алерты, направленные на receiver `grafana-oncall`, будут поступать в Grafana OnCall для 
дальнейшей обработки.

### Маршрутизация оповещений

Получив алерт от Alertmanager, Grafana OnCall начинает процесс маршрутизации. Основная задача — доставить оповещение 
дежурному специалисту или целой команде наиболее удобным способом, с учётом расписаний, приоритетов и путей эскалации.

В OnCall можно настроить расписания дежурств, определить, кто и когда отвечает за реагирование, а также установить 
каналы уведомлений — например, Telegram. Для этого администратор подключает Telegram-бота, указывает идентификаторы 
чатов или пользователей и настраивает правила маршрутизации уведомлений (routing policies).

При срабатывании правила в расписанный промежуток времени, алерт трансформируется в оповещение и автоматически 
отправляется дежурному или команде в Telegram. Если алерт не подтверждён (acknowledged) в установленный срок, 
система может эскалировать его по цепочке — отправить следующему специалисту или группе.

Таким образом, Grafana OnCall обеспечивает надёжное и гибкое информирование о критичных событиях: от генерации алерта 
в Prometheus, передачи через vmalert и Alertmanager, до доставки уведомления ответственному сотруднику в Telegram, 
минимизируя время реакции на инциденты.

## Настройка Grafana OnCall для оповещения в Telegram
### Получение алертов в личных сообщениях Telegram
Чтобы получать нотификации в своих личных сообщениях Telegram и иметь возможность выполнять действия (подтвердить, 
решить, замолчать оповещение) прямо из чата:

- Откройте свой профиль в Grafana OnCall.
- Найдите настройку Telegram, нажмите “Connect”.
- Для автоматического подключения нажмите “Connect automatically”. OnCall-бот пришлёт вам сообщение — нажмите “Старт” 
- в Telegram и дождитесь подтверждения соединения.
- Теперь вы будете получать оповещения непосредственно в Telegram.

Если требуется подключить Telegram вручную:
- Используйте сгенерированную ссылку для начала диалога с OnCall-ботом и отправьте команду “Старт”.

## Заключение
Интеграция Grafana OnCall с Telegram — это быстрый способ организовать современную командную коммуникацию по 
инцидентам без лишней бюрократии. Вы можете гибко выбирать, кому доставлять алерты (лично или в командный чат), 
и всё управление инцидентом удобно ведётся прямо из Telegram.

**Плюсы использования Grafana OnCall**:

Grafana OnCall предоставляет централизованную платформу для эффективного управления алертами и инцидентами. 
Простота интеграции с популярными инструментами мониторинга и коммуникационными платформами, такими как Telegram, 
делает этот инструмент очень гибким. Благодаря роли системы duty-ростеров и эскалаций команда может не переживать 
о том, что важные события останутся без внимания — каждый инцидент быстро доходит до ответственного человека. 
Интерфейс OnCall интуитивно понятен, а масштабирование и поддержка настроек пользователей позволяют оптимизировать 
рабочие процессы под каждую команду.
